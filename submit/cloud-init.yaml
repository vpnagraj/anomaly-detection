#cloud-config

## ==================== PACKAGE MANAGEMENT SETUP ====================
## configure apt as package manager
apt:
  sources:
    ubuntu:
      ## point to the official Ubuntu package repository
      ## $RELEASE will be replaced with the OS version env variable in the AMI (focal, jammy, etc.)
      source: 'deb http://archive.ubuntu.com/ubuntu $RELEASE main universe'
  conf: |
    ## skip the install for recommended packages to save time
    APT {
      Install-Recommends 0;
    };

## ==================== INSTALL SYSTEM PACKAGES ====================
packages:
  - python3
  - python3-pip
  - python3-venv
  - git
  - awscli

## ==================== WRITE ENV FILE ====================
## write_files runs before runcmd, so the env var is available to the app
## this is the cloud-init native way to write files (vs echo >> in a shell script)
write_files:
  - path: /etc/environment
    ## append to the existing file rather than overwriting
    append: true
    content: |
      BUCKET_NAME=${bucket_name}

## ==================== RUN SETUP COMMANDS ====================
## runcmd is a list of shell commands to run (in order) during boot
runcmd:
  ## === Step 1: Create the directory ===
  ## /opt is a standard location for third-party applications in Linux
  - mkdir -p /opt

  ## === Step 2: Clone application code ===
  - cd /opt && git clone https://github.com/vpnagraj/anomaly-detection.git

  ## === Step 3: Create a Python virtual environment ===
  - python3 -m venv /opt/anomaly-detection/venv

  ## === Step 4: Upgrade pip inside the virtual environment ===
  - /opt/anomaly-detection/venv/bin/pip install --upgrade pip

  ## === Step 5: Install Python dependencies ===
  ## everything is pip installable through requirements.txt
  - /opt/anomaly-detection/venv/bin/pip install -r /opt/anomaly-detection/requirements.txt

  ## === Step 6: Create a systemd service file ===
  ## a service file tells systemd how to start/stop/restart the app ...
  ## ... preferred over plain bash because systemd handles:
  ##   - automatic restart if the app crashes
  ##   - logging to journalctl (system logging)
  ##   - starting on boot
  ##   - graceful shutdown
  ## the 'cat > file << EOF' syntax writes multi-line content to a file ...
  ## ... so we're kind of writing this on the fly during the cloud init
  - |
    cat > /etc/systemd/system/fastapi-app.service << 'EOF'
    [Unit]
    Description=FastAPI Anomaly Detection App
    After=network.target

    [Service]
    Type=simple
    User=root
    WorkingDirectory=/opt/anomaly-detection
    Environment="PATH=/opt/anomaly-detection/venv/bin"
    EnvironmentFile=/etc/environment
    ExecStart=/opt/anomaly-detection/venv/bin/fastapi run /opt/anomaly-detection/app.py --host 0.0.0.0
    Restart=on-failure
    RestartSec=5

    [Install]
    WantedBy=multi-user.target
    EOF

  ## === Step 7: Reload systemd configuration ===
  ## systemctl daemon-reload scans /etc/systemd/system/ for new services
  - systemctl daemon-reload

  ## === Step 8: Enable the service on boot ===
  ## systemctl enable makes the service start automatically when the instance boots
  - systemctl enable fastapi-app.service

  ## === Step 9: Start the service immediately ===
  ## systemctl start runs the service right now (don't wait for reboot)
  - systemctl start fastapi-app.service

  ## === Step 10: Wait for the app to be ready ===
  - |
    echo "Waiting for FastAPI to start..."
    for i in $(seq 1 30); do
      curl -sf http://localhost:8000/ > /dev/null 2>&1 && break
      sleep 2
    done

  ## === Step 11: Wait for Elastic IP to be associated ===
  ## the EIP association is a separate TF resource that may not be done yet
  ## instance metadata reflects the public IP only after association completes
  - |
    echo "Waiting for Elastic IP association..."
    for i in $(seq 1 60); do
      TOKEN=$(curl -sf -X PUT "http://169.254.169.254/latest/api/token" \
        -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
      PUBLIC_IP=$(curl -sf -H "X-aws-ec2-metadata-token: $TOKEN" \
        http://169.254.169.254/latest/meta-data/public-ipv4 || true)
      [ -n "$PUBLIC_IP" ] && echo "EIP associated: $PUBLIC_IP" && break
      sleep 5
    done

  ## === Step 12: Subscribe to SNS topic ===
  ## this triggers the SubscriptionConfirmation POST to /notify while the app is running
  - >
    aws sns subscribe
    --topic-arn ${topic_arn}
    --protocol http
    --endpoint http://${elastic_ip}:8000/notify
    --region ${aws_region}

## ==================== LOGGING ====================
## configure cloud-init output logging
output:
  ## 'all' means: capture all cloud-init output
  ## '| tee -a /var/log/cloud-init-output.log' sends output to the log file
  ## NOTE: you can SSH in and read/tail this file to debug cloud-init
  all: '| tee -a /var/log/cloud-init-output.log'
